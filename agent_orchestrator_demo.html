<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Orchestrator Server</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.2em;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .panel h3 {
            margin-bottom: 15px;
            color: #667eea;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        /* Agent Registry */
        .agent-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            background: #f8f9ff;
            border-left: 4px solid #667eea;
        }

        .register-agent-btn {
            width: 100%;
            padding: 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 15px;
        }

        .register-agent-btn:hover {
            background: #218838;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        .agent-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
            color: white;
        }

        .agent-icon.n8n {
            background: #ff6d5a;
        }

        .agent-icon.sap {
            background: #0a6ed1;
        }

        .agent-icon.azure {
            background: #0078d4;
        }

        .agent-icon.salesforce {
            background: #00a1e0;
        }

        .agent-info h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .agent-info p {
            font-size: 0.9em;
            color: #666;
        }

        .agent-status {
            margin-left: auto;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            background: #e8f5e8;
            color: #2d5a2d;
        }

        /* Task List Visualization */
        .workflow-tasks {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 4px solid #e0e0e0;
        }

        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .task-item.pending {
            border-left-color: #ffc107;
        }

        .task-item.processing {
            border-left-color: #17a2b8;
            animation: pulse 1.5s infinite;
        }

        .task-item.completed {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .task-item.error {
            border-left-color: #dc3545;
            background: #fff8f8;
        }

        @keyframes pulse {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-2px) scale(1.02); }
            100% { transform: translateY(0) scale(1); }
        }

        .task-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .task-item.completed .task-number {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .task-item.processing .task-number {
            background: linear-gradient(135deg, #17a2b8, #20c997);
        }

        .task-item.error .task-number {
            background: linear-gradient(135deg, #dc3545, #c62828);
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .task-description {
            color: #666;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .task-agent {
            font-size: 0.85em;
            color: #667eea;
            font-weight: bold;
        }

        .task-status {
            margin-left: 15px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
            min-width: 80px;
            text-align: center;
        }

        .task-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .task-status.processing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .task-status.completed {
            background: #d4edda;
            color: #155724;
        }

        .task-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .workflow-info {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            font-size: 0.9em;
        }

        /* Control Panel */
        .control-form {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1em;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .execute-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .execute-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .execute-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-indicator {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .status-indicator.idle {
            background: #e9ecef;
            color: #6c757d;
        }

        .status-indicator.running {
            background: #fff3cd;
            color: #856404;
        }

        .status-indicator.success {
            background: #d4edda;
            color: #155724;
        }

        .status-indicator.error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Results Panel */
        .results-panel {
            grid-column: 1 / -1;
            min-height: 200px;
        }

        .result-step {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9ff;
            border-left: 4px solid #667eea;
        }

        .result-step h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .result-content {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
            max-height: 150px;
            overflow-y: auto;
        }

        .json-viewer {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            color: #333;
        }

        .summary-card {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .summary-card h4 {
            margin-bottom: 10px;
        }

        .hidden {
            display: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Agent Details Modal */
        .agent-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            z-index: 2000;
            overflow-y: auto;
        }

        .agent-details-content {
            position: relative;
            background: white;
            margin: 30px auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        .agent-details-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #f0f0f0;
        }

        .agent-details-header .agent-icon {
            width: 60px;
            height: 60px;
            font-size: 1.5em;
            margin-right: 20px;
        }

        .agent-details-title h2 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .agent-details-title p {
            color: #666;
            font-size: 0.95em;
        }

        .api-section {
            margin-bottom: 25px;
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .api-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .api-endpoint {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin-bottom: 15px;
        }

        .api-endpoint .method {
            color: #50fa7b;
            font-weight: bold;
        }

        .api-endpoint .url {
            color: #8be9fd;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .code-block .key {
            color: #ff79c6;
        }

        .code-block .string {
            color: #f1fa8c;
        }

        .code-block .number {
            color: #bd93f9;
        }

        .code-block .boolean {
            color: #50fa7b;
        }

        .info-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .info-badge.capability {
            background: #e3f2fd;
            color: #1976d2;
        }

        .info-badge.type {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 0.85em;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s ease;
        }

        .copy-btn:hover {
            background: #5568d3;
        }

        .agent-item {
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .agent-item:hover {
            background: #eef0ff !important;
        }

        .export-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            font-size: 0.8em;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Multi-Agent Orchestrator Server</h1>
            <p>AI Agent Collaboration Across Different Platforms</p>
        </div>

        <div class="dashboard">
            <!-- Agent Registry Panel -->
            <div class="panel">
                <h3>üîß Registered Agents</h3>
                <div id="agentRegistry">
                    <div class="agent-item" onclick="showAgentDetails('n8n-customer')">
                        <div class="agent-icon n8n">n8n</div>
                        <div class="agent-info">
                            <h4>Customer Processor</h4>
                            <p>Data analysis & processing agent</p>
                        </div>
                        <span class="agent-status">Active</span>
                    </div>
                    <div class="agent-item" onclick="showAgentDetails('sap-ai-core')">
                        <div class="agent-icon sap">SAP</div>
                        <div class="agent-info">
                            <h4>Enterprise Data Enrichment</h4>
                            <p>SAP AI Core billing & eligibility agent</p>
                        </div>
                        <span class="agent-status">Active</span>
                    </div>
                    <div class="agent-item" onclick="showAgentDetails('azure-ai')">
                        <div class="agent-icon azure">Azure</div>
                        <div class="agent-info">
                            <h4>Energy Consultant</h4>
                            <p>AI-powered recommendations agent</p>
                        </div>
                        <span class="agent-status">Active</span>
                    </div>
                    <div class="agent-item" onclick="showAgentDetails('salesforce')">
                        <div class="agent-icon salesforce">SF</div>
                        <div class="agent-info">
                            <h4>Service History</h4>
                            <p>Salesforce Agentforce CRM agent</p>
                        </div>
                        <span class="agent-status">Active</span>
                    </div>
                    <div class="agent-item" onclick="showAgentDetails('n8n-validator')">
                        <div class="agent-icon n8n">n8n</div>
                        <div class="agent-info">
                            <h4>Validator</h4>
                            <p>Compliance & validation agent</p>
                        </div>
                        <span class="agent-status">Active</span>
                    </div>
                </div>
                <button class="register-agent-btn" onclick="showRegisterModal()">
                    ‚ûï Register New Agent
                </button>
            </div>

            <!-- Task List Panel -->
            <div class="panel">
                <h3>üìã Orchestration Tasks</h3>
                <div class="workflow-tasks">
                    <div class="task-item pending" id="task1">
                        <div class="task-number">1</div>
                        <div class="task-content">
                            <div class="task-title">Customer Data Processing</div>
                            <div class="task-description">Process customer inquiry, validate input data, extract insights, and prepare structured data for AI analysis</div>
                            <div class="task-agent">üë§ Agent: n8n Customer Processor</div>
                        </div>
                        <div class="task-status pending">Pending</div>
                    </div>

                    <div class="task-item pending" id="task2">
                        <div class="task-number">2</div>
                        <div class="task-content">
                            <div class="task-title">Enterprise Data Enrichment</div>
                            <div class="task-description">Retrieve customer billing history, energy consumption patterns, active contracts, and program eligibility from SAP ERP/CRM systems via AI Core Orchestration v2</div>
                            <div class="task-agent">üè¢ Agent: SAP AI Core Data Enrichment</div>
                        </div>
                        <div class="task-status pending">Pending</div>
                    </div>

                    <div class="task-item pending" id="task3">
                        <div class="task-number">3</div>
                        <div class="task-content">
                            <div class="task-title">Energy Consultation Analysis</div>
                            <div class="task-description">Use GPT-4 to analyze customer profile and SAP enterprise data to generate personalized energy efficiency recommendations with savings potential</div>
                            <div class="task-agent">ü§ñ Agent: Azure AI Energy Consultant</div>
                        </div>
                        <div class="task-status pending">Pending</div>
                    </div>

                    <div class="task-item pending" id="task4">
                        <div class="task-number">4</div>
                        <div class="task-content">
                            <div class="task-title">Service History Check</div>
                            <div class="task-description">Query Salesforce CRM to retrieve customer service history, open cases, previous inquiries, and account standing to inform final recommendations</div>
                            <div class="task-agent">üìû Agent: Salesforce Agentforce</div>
                        </div>
                        <div class="task-status pending">Pending</div>
                    </div>

                    <div class="task-item pending" id="task5">
                        <div class="task-number">5</div>
                        <div class="task-content">
                            <div class="task-title">Compliance Validation</div>
                            <div class="task-description">Validate AI recommendations for compliance, accuracy, and risk assessment before final approval</div>
                            <div class="task-agent">‚úÖ Agent: n8n Validator</div>
                        </div>
                        <div class="task-status pending">Pending</div>
                    </div>
                </div>
                
                <div class="workflow-info" id="workflowInfo">
                    <strong>Workflow Status:</strong> <span id="workflowStatus">Ready to execute - 5 tasks pending</span>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="panel">
                <h3>üéØ Execute Orchestration</h3>
                <form class="control-form" id="orchestrationForm">
                    <div class="form-group">
                        <label for="customerInquiry">Customer Inquiry:</label>
                        <input type="text" id="customerInquiry" value="I want to reduce my electricity bill" placeholder="Enter customer inquiry...">
                    </div>
                    <div class="form-group">
                        <label for="homeType">Home Type:</label>
                        <select id="homeType">
                            <option value="apartment">Apartment</option>
                            <option value="house">House</option>
                            <option value="condo">Condo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="currentBill">Current Monthly Bill ($):</label>
                        <input type="number" id="currentBill" value="150" min="0" placeholder="Enter current bill amount">
                    </div>
                    <button type="submit" class="execute-btn" id="executeBtn">
                        üöÄ Execute 5-Agent Orchestration
                    </button>
                </form>
                <div class="status-indicator idle" id="statusIndicator">
                    System Ready
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="panel results-panel hidden" id="resultsPanel">
            <div class="results-header">
                <h3>üìä Orchestration Results</h3>
                <div class="btn-group">
                    <button class="export-btn" onclick="exportResults()">
                        üíæ Export Results JSON
                    </button>
                </div>
            </div>
            <div id="resultsContent">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <!-- Agent Registration Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <span class="close-modal" onclick="hideRegisterModal()">&times;</span>
            <h3>üîß Register New Agent</h3>
            <form id="registerForm">
                <div class="form-group">
                    <label for="agentId">Agent ID:</label>
                    <input type="text" id="agentId" placeholder="e.g., my-custom-agent-001" required>
                </div>
                <div class="form-group">
                    <label for="agentType">Agent Type:</label>
                    <select id="agentType" required>
                        <option value="">Select Type</option>
                        <option value="n8n">n8n Workflow</option>
                        <option value="azure_ai">Azure AI Agent</option>
                        <option value="custom">Custom API</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="agentCapabilities">Capabilities (comma separated):</label>
                    <input type="text" id="agentCapabilities" placeholder="e.g., data_processing, analysis" required>
                </div>
                <div class="form-group">
                    <label for="webhookUrl">Webhook URL:</label>
                    <input type="url" id="webhookUrl" placeholder="https://your-endpoint.com/webhook" required>
                </div>
                <button type="submit" class="execute-btn" disabled style="opacity: 0.6;">
                    üö´ Register Agent (Demo Only)
                </button>
                <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    <em>Note: This is a demonstration interface. Agent registration is disabled in demo mode.</em>
                </p>
            </form>
        </div>
    </div>

    <!-- Agent Details Modal -->
    <div class="agent-details-modal" id="agentDetailsModal">
        <div class="agent-details-content">
            <span class="close-modal" onclick="hideAgentDetails()">&times;</span>
            <div id="agentDetailsContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        
        class AgentOrchestrator {
            constructor() {
                this.isExecuting = false;
                this.lastResults = null; // Store full results for export
                this.initializeEventListeners();
                this.checkSystemHealth();
            }

            initializeEventListeners() {
                document.getElementById('orchestrationForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.executeOrchestration();
                });

                // Add click listeners to task items for info
                ['task1', 'task2', 'task3', 'task4', 'task5'].forEach(taskId => {
                    document.getElementById(taskId).addEventListener('click', () => {
                        this.showTaskInfo(taskId);
                    });
                });
            }

            async checkSystemHealth() {
                try {
                    const response = await fetch(`${API_BASE}/health`);
                    const health = await response.json();
                    
                    if (health.status === 'healthy') {
                        this.updateWorkflowStatus('System healthy - All agents ready - 5 tasks pending');
                    } else {
                        this.updateWorkflowStatus('System issues detected', 'error');
                    }
                } catch (error) {
                    this.updateWorkflowStatus('Unable to connect to orchestrator', 'error');
                    console.error('Health check failed:', error);
                }
            }

            async executeOrchestration() {
                if (this.isExecuting) return;

                this.isExecuting = true;
                this.resetTasks();
                this.updateExecuteButton(true, 'Executing...');
                this.updateStatusIndicator('running', 'Orchestration in progress...');
                this.showResults();

                const payload = {
                    task: "energy efficiency consultation",
                    data: {
                        customer_id: Date.now().toString(),
                        inquiry: document.getElementById('customerInquiry').value,
                        home_type: document.getElementById('homeType').value,
                        current_bill: parseInt(document.getElementById('currentBill').value)
                    }
                };

                try {
                    // Simulate real-time progress
                    this.simulateProgress();

                    const response = await fetch(`${API_BASE}/orchestrate-energy`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.status === 'completed') {
                        this.handleSuccess(result);
                    } else {
                        this.handleError(result.error || 'Unknown error occurred');
                    }

                } catch (error) {
                    this.handleError(`Network error: ${error.message}`);
                } finally {
                    this.isExecuting = false;
                    this.updateExecuteButton(false, 'üöÄ Execute 5-Agent Orchestration');
                }
            }

            simulateProgress() {
                // Task 1: Customer Processing
                setTimeout(() => {
                    this.updateTaskStatus('task1', 'processing');
                    this.updateWorkflowStatus('Task 1: Processing customer data...');
                }, 500);

                // Task 2: SAP Enterprise Data Enrichment (realistic 2-4s delay)
                setTimeout(() => {
                    this.updateTaskStatus('task1', 'completed');
                    this.updateTaskStatus('task2', 'processing');
                    this.updateWorkflowStatus('Task 2: Retrieving enterprise data from SAP AI Core...');
                }, 2000);

                // Task 3: Azure AI Consultation
                setTimeout(() => {
                    this.updateTaskStatus('task2', 'completed');
                    this.updateTaskStatus('task3', 'processing');
                    this.updateWorkflowStatus('Task 3: Getting AI recommendations...');
                }, 5000);  // 2s + 3s (SAP takes 2-4s realistically)

                // Task 4: Salesforce Service History
                setTimeout(() => {
                    this.updateTaskStatus('task3', 'completed');
                    this.updateTaskStatus('task4', 'processing');
                    this.updateWorkflowStatus('Task 4: Checking customer service history...');
                }, 8000);  // Previous + 3s for AI processing

                // Task 5: Validation
                setTimeout(() => {
                    this.updateTaskStatus('task4', 'completed');
                    this.updateTaskStatus('task5', 'processing');
                    this.updateWorkflowStatus('Task 5: Validating recommendations...');
                }, 10000);  // Previous + 2s for Salesforce
            }

            handleSuccess(result) {
                this.lastResults = result; // Store full results for export
                this.updateTaskStatus('task5', 'completed');
                this.updateStatusIndicator('success', 'Orchestration completed successfully!');
                this.updateWorkflowStatus('All tasks completed successfully - 5/5 complete');
                this.displayResults(result);
            }

            handleError(error) {
                this.updateStatusIndicator('error', `Error: ${error}`);
                this.updateWorkflowStatus('Orchestration failed', 'error');
                
                // Mark current processing task as error
                ['task1', 'task2', 'task3', 'task4', 'task5'].forEach(taskId => {
                    const task = document.getElementById(taskId);
                    if (task.classList.contains('processing')) {
                        this.updateTaskStatus(taskId, 'error');
                    }
                });
            }

            displayResults(result) {
                const resultsContent = document.getElementById('resultsContent');
                
                let html = `
                    <div class="result-step">
                        <h4>üéØ Task Summary</h4>
                        <div class="result-content">
                            <div class="json-viewer">
Task: ${result.task}
Workflow: ${result.workflow}
Final Status: ${result.final_status}
Agents Used: ${result.agents_used.length}
                            </div>
                        </div>
                    </div>
                `;

                if (result.step1_customer_processing) {
                    html += `
                        <div class="result-step">
                            <h4>üìã Step 1: Customer Processing</h4>
                            <div class="result-content">
                                <div class="json-viewer">${JSON.stringify(result.step1_customer_processing, null, 2)}</div>
                            </div>
                        </div>
                    `;
                }

                if (result.step2_sap_enrichment) {
                    html += `
                        <div class="result-step">
                            <h4>üè¢ Step 2: SAP Enterprise Data Enrichment</h4>
                            <div class="result-content">
                                <div class="json-viewer">${JSON.stringify(result.step2_sap_enrichment, null, 2)}</div>
                            </div>
                        </div>
                    `;
                }

                if (result.step3_ai_recommendations) {
                    html += `
                        <div class="result-step">
                            <h4>ü§ñ Step 3: AI Recommendations</h4>
                            <div class="result-content">
                                <div class="json-viewer">${this.formatAIRecommendations(result.step3_ai_recommendations)}</div>
                            </div>
                        </div>
                    `;
                }

                if (result.step4_salesforce_history) {
                    html += `
                        <div class="result-step">
                            <h4>üìû Step 4: Salesforce Service History</h4>
                            <div class="result-content">
                                <div class="json-viewer">${JSON.stringify(result.step4_salesforce_history, null, 2)}</div>
                            </div>
                        </div>
                    `;
                }

                if (result.step5_validation) {
                    html += `
                        <div class="result-step">
                            <h4>‚úÖ Step 5: Validation</h4>
                            <div class="result-content">
                                <div class="json-viewer">${JSON.stringify(result.step5_validation, null, 2)}</div>
                            </div>
                        </div>
                    `;
                }

                // Generate consultation summary from actual validation results
                if (result.step5_validation) {
                    const validationResult = result.step5_validation.result || result.step5_validation;
                    const approvalStatus = validationResult.approval_status;
                    const complianceScore = validationResult.compliance_score;
                    const riskLevel = validationResult.risk_level;
                    
                    // Determine validation status
                    let validationStatus = 'Failed';
                    let statusColor = '#dc3545'; // red
                    
                    if (approvalStatus === 'approved' || complianceScore >= 85) {
                        validationStatus = 'Passed';
                        statusColor = '#28a745'; // green
                    } else if (approvalStatus === 'needs_review' || complianceScore >= 70) {
                        validationStatus = 'Needs Review';
                        statusColor = '#ffc107'; // yellow
                    }
                    
                    // Extract potential savings from AI recommendations
                    let estimatedSavings = 'N/A';
                    if (result.step3_ai_recommendations && result.step3_ai_recommendations.consultation_response) {
                        const aiText = result.step3_ai_recommendations.consultation_response;
                        // Look for savings ranges in the AI response
                        const savingsMatch = aiText.match(/\$(\d+(?:\.\d{2})?)\s*[‚Äì-]\s*\$(\d+(?:\.\d{2})?)/);
                        if (savingsMatch) {
                            estimatedSavings = `$${savingsMatch[1]} - $${savingsMatch[2]} per month`;
                        }
                    }
                    
                    html += `
                        <div class="summary-card" style="background: linear-gradient(45deg, ${statusColor}, ${statusColor}CC);">
                            <h4>üìÑ Consultation Summary</h4>
                            <p><strong>Validation:</strong> ${validationStatus}</p>
                            <p><strong>Compliance Score:</strong> ${complianceScore}/100</p>
                            <p><strong>Risk Level:</strong> ${riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1)}</p>
                            <p><strong>Estimated Savings:</strong> ${estimatedSavings}</p>
                        </div>
                    `;
                }

                resultsContent.innerHTML = html;
            }

            formatAIRecommendations(recommendations) {
                if (recommendations.consultation_response) {
                    return recommendations.consultation_response; // Show full response
                }
                return JSON.stringify(recommendations, null, 2);
            }

            showTaskInfo(taskId) {
                const taskInfo = {
                    'task1': 'Customer Data Processing: Analyzes customer inquiry, validates input data, and prepares it for AI consultation',
                    'task2': 'Enterprise Data Enrichment: Retrieves billing history, consumption patterns, contracts, and program eligibility from SAP ERP/CRM via AI Core Orchestration v2',
                    'task3': 'Energy Consultation: Uses AI to analyze customer profile and SAP enterprise data to generate personalized energy efficiency recommendations',
                    'task4': 'Service History Check: Queries Salesforce CRM to retrieve customer service history, open cases, previous inquiries, and account standing',
                    'task5': 'Compliance Validation: Validates AI recommendations for compliance, accuracy, and risk assessment'
                };
                
                alert(taskInfo[taskId] || 'Task information not available');
            }

            updateTaskStatus(taskId, status) {
                const task = document.getElementById(taskId);
                const statusElement = task.querySelector('.task-status');
                
                // Remove all status classes
                task.classList.remove('pending', 'processing', 'completed', 'error');
                statusElement.classList.remove('pending', 'processing', 'completed', 'error');
                
                // Add new status
                task.classList.add(status);
                statusElement.classList.add(status);
                statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            }

            resetTasks() {
                ['task1', 'task2', 'task3', 'task4', 'task5'].forEach(taskId => {
                    this.updateTaskStatus(taskId, 'pending');
                });
            }

            updateWorkflowStatus(message, type = 'info') {
                document.getElementById('workflowStatus').textContent = message;
            }

            updateExecuteButton(disabled, text) {
                const btn = document.getElementById('executeBtn');
                btn.disabled = disabled;
                btn.innerHTML = disabled ? `<span class="loading-spinner"></span> ${text}` : text;
            }

            updateStatusIndicator(type, message) {
                const indicator = document.getElementById('statusIndicator');
                indicator.className = `status-indicator ${type}`;
                indicator.textContent = message;
            }

            showResults() {
                document.getElementById('resultsPanel').classList.remove('hidden');
            }
        }

        // Initialize the orchestrator when the page loads
        let orchestrator;
        document.addEventListener('DOMContentLoaded', () => {
            orchestrator = new AgentOrchestrator();
        });

        // Modal functions
        function showRegisterModal() {
            document.getElementById('registerModal').style.display = 'block';
        }

        function hideRegisterModal() {
            document.getElementById('registerModal').style.display = 'none';
        }

        // Export functionality
        function exportResults() {
            if (!orchestrator || !orchestrator.lastResults) {
                alert('No results available to export. Please run an orchestration first.');
                return;
            }

            const exportData = {
                export_timestamp: new Date().toISOString(),
                orchestration_metadata: {
                    demo_version: "3.0",
                    agents_count: 5,
                    workflow_type: "five_agent_energy_consultation"
                },
                full_results: orchestrator.lastResults
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `agent_orchestration_results_${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Agent Details Functions
        function showAgentDetails(agentType) {
            const modal = document.getElementById('agentDetailsModal');
            const content = document.getElementById('agentDetailsContent');
            
            const agentData = getAgentData(agentType);
            content.innerHTML = agentData;
            modal.style.display = 'block';
        }

        function hideAgentDetails() {
            document.getElementById('agentDetailsModal').style.display = 'none';
        }

        function getAgentData(agentType) {
            const agents = {
                'n8n-customer': {
                    name: 'n8n Customer Processor',
                    type: 'n8n Workflow',
                    icon: 'n8n',
                    description: 'Processes and validates customer inquiry data using n8n workflow automation',
                    capabilities: ['customer_processing', 'data_analysis'],
                    endpoint: 'https://gabrielpierobon.app.n8n.cloud/webhook/931a4dbc-3fa5-432f-8c1c-a60206a46b4a',
                    method: 'POST',
                    requestSchema: `{
  "task": "process energy customer inquiry",
  "data": {
    "customer_id": "12345",
    "inquiry": "I want to reduce my electricity bill",
    "home_type": "apartment",
    "current_bill": 150
  },
  "timestamp": "2025-01-18T10:00:00Z",
  "source": "multi_agent_orchestrator"
}`,
                    responseSchema: `[
  {
    "output": {
      "customer_id": "12345",
      "processed_inquiry": "energy efficiency consultation",
      "customer_segment": "residential",
      "priority_level": "medium",
      "extracted_data": {
        "home_type": "apartment",
        "monthly_bill": 150,
        "concerns": ["cost_reduction", "efficiency"]
      },
      "processing_timestamp": "2025-01-18T10:00:05Z"
    }
  }
]`
                },
                'sap-ai-core': {
                    name: 'SAP AI Core Data Enrichment',
                    type: 'SAP AI Core Orchestration v2',
                    icon: 'sap',
                    description: 'Retrieves enterprise billing history, energy consumption patterns, and program eligibility from SAP ERP/CRM systems using AI Core Orchestration v2',
                    capabilities: ['enterprise_data_enrichment', 'billing_analysis', 'eligibility_verification'],
                    endpoint: 'https://api.ai.prod.eu-central-1.aws.ml.hana.ondemand.com/v2/lm/deployments/d12a3b4c5d6e7f8g9h0i/v2/completion',
                    method: 'POST',
                    headers: `Authorization: Bearer <access_token>
AI-Resource-Group: default
Content-Type: application/json`,
                    requestSchema: `{
  "orchestration_config": {
    "module_configurations": {
      "llm_module_config": {
        "model_name": "gpt-4o",
        "model_params": {
          "max_tokens": 2000,
          "temperature": 0.3
        }
      },
      "templating_module_config": {
        "template": [
          {
            "role": "system",
            "content": "You are an SAP ERP data analyst. Retrieve and analyze customer billing and eligibility data."
          },
          {
            "role": "user",
            "content": "Retrieve complete enterprise data for customer ID {{?customer_id}}: billing history, energy consumption, active contracts, and program eligibility."
          }
        ]
      },
      "grounding_module_config": {
        "grounding_service": "sap_erp_data_source",
        "data_repositories": [
          "SAP_ERP_Customer_Master",
          "SAP_CRM_Contracts",
          "SAP_Billing_History"
        ],
        "filters": {
          "customer_id": "{{?customer_id}}"
        }
      }
    }
  },
  "input_params": {
    "customer_id": "12345"
  },
  "return_module_results": true
}`,
                    responseSchema: `{
  "request_id": "sap-req-1706438405-2345",
  "orchestration_result": {
    "customer_id": "12345",
    "account_status": {
      "account_number": "SAP-12345678",
      "account_type": "residential",
      "status": "active",
      "payment_standing": "excellent",
      "account_age_months": 48
    },
    "billing_history": {
      "average_monthly_bill": 152.45,
      "last_12_months_total": 1829.40,
      "peak_usage_month": "August",
      "lowest_usage_month": "April",
      "billing_trend": "increasing"
    },
    "energy_consumption": {
      "average_kwh_monthly": 890,
      "last_month_kwh": 945,
      "usage_pattern": "seasonal_peaks",
      "peak_demand_kw": 6.2
    },
    "active_contracts": [
      {
        "contract_id": "CNT-456789",
        "contract_type": "standard_residential",
        "rate_plan": "time_of_use",
        "start_date": "2023-01-15",
        "renewal_date": "2025-01-15"
      }
    ],
    "program_eligibility": {
      "energy_efficiency_rebate": true,
      "smart_thermostat_program": true,
      "solar_incentive_program": false
    },
    "eligibility_summary": {
      "total_programs_eligible": 2,
      "recommended_programs": [
        "energy_efficiency_rebate",
        "smart_thermostat_program"
      ]
    }
  },
  "module_results": {
    "llm": {
      "model": "gpt-4o",
      "usage": {
        "prompt_tokens": 285,
        "completion_tokens": 198,
        "total_tokens": 483
      }
    },
    "grounding": {
      "documents_retrieved": 5,
      "sources": ["SAP_ERP_Customer_Master", "SAP_CRM_Contracts", "SAP_Billing_History"]
    }
  },
  "processing_time_ms": 3420
}`
                },
                'azure-ai': {
                    name: 'Azure AI Energy Consultant',
                    type: 'Azure AI Foundry Agent',
                    icon: 'azure',
                    description: 'Provides personalized energy efficiency recommendations using GPT-4o via Azure AI Foundry',
                    capabilities: ['energy_consultation', 'customer_service', 'energy_efficiency'],
                    endpoint: 'https://api.azureml.net/agents/asst_aq7lhFm8W8ldxwte9pynGlsk/threads',
                    method: 'POST',
                    agentId: 'asst_aq7lhFm8W8ldxwte9pynGlsk',
                    requestSchema: `// Step 1: Create Thread
POST /threads
{}

// Step 2: Send Message
POST /threads/{thread_id}/messages
{
  "role": "user",
  "content": "I have a customer inquiry about energy efficiency.\\n\\nCustomer Profile: {...}\\nSAP Enterprise Data: {...}\\nOriginal Inquiry: I want to reduce my electricity bill\\nHome Type: apartment\\nCurrent Monthly Bill: $150\\n\\nProvide specific energy efficiency program recommendations."
}

// Step 3: Run Agent
POST /threads/{thread_id}/runs
{
  "agent_id": "asst_aq7lhFm8W8ldxwte9pynGlsk"
}

// Step 4: Poll Run Status
GET /threads/{thread_id}/runs/{run_id}

// Step 5: Get Messages
GET /threads/{thread_id}/messages`,
                    responseSchema: `{
  "data": [
    {
      "id": "msg_abc123",
      "role": "assistant",
      "content": [
        {
          "type": "text",
          "text": {
            "value": "Based on your apartment profile and current $150/month bill, I recommend:\\n\\n1. Smart Thermostat Program\\n   - Savings: $15-25/month\\n   - Installation: Free via utility rebate\\n   - Timeline: 2-3 weeks\\n\\n2. LED Lighting Upgrade\\n   - Savings: $8-12/month\\n   - Rebate: $50 available\\n   - Timeline: Immediate\\n\\n3. Energy Audit Service\\n   - Cost: Free for eligible customers\\n   - Potential savings: 10-20% reduction\\n   - Timeline: Schedule within 1 week\\n\\nTotal estimated savings: $23-37/month"
          }
        }
      ],
      "thread_id": "thread_xyz789",
      "created_at": 1706438410
    }
  ]
}`
                },
                'salesforce': {
                    name: 'Salesforce Agentforce Service History',
                    type: 'Salesforce Agentforce',
                    icon: 'salesforce',
                    description: 'Checks customer service history, open cases, previous inquiries, and account standing from Salesforce CRM using Agentforce Agent API',
                    capabilities: ['crm_service_history', 'case_management', 'customer_insights'],
                    endpoint: 'https://api.salesforce.com/einstein/ai-agent/v1/agents/{AGENT_ID}/sessions',
                    method: 'POST',
                    agentId: '0XxKj000001I9DuKAK',
                    requestSchema: `// Step 1: Create Session
POST /einstein/ai-agent/v1/agents/{AGENT_ID}/sessions
{
  "externalSessionKey": "{RANDOM_UUID}",
  "instanceConfig": {
    "endpoint": "https://{MY_DOMAIN_URL}"
  },
  "streamingCapabilities": {
    "chunkTypes": ["Text"]
  },
  "bypassUser": true
}

// Step 2: Send Message
POST /einstein/ai-agent/v1/sessions/{SESSION_ID}/messages/stream
{
  "message": {
    "type": "Text",
    "text": "Check service history for customer {customer_id}. Do they have open cases or recent complaints related to energy efficiency?",
    "sequenceId": 1
  }
}

// Step 3: Session Auto-Expires (no explicit end needed)`,
                    responseSchema: `// Session Creation Response
{
  "sessionId": "0199a082-831b-77d1-b025-4ec68d203bf3",
  "_links": {
    "self": null,
    "messages": {
      "href": "https://api.salesforce.com/einstein/ai-agent/v1/sessions/{SESSION_ID}/messages/stream"
    }
  },
  "messages": [
    {
      "type": "Inform",
      "id": "8e7cafae-0eb5-44b1-9195-21f1cd6e1f4b",
      "message": "Hi, I'm an AI service assistant. How can I help you?"
    }
  ]
}

// Message Response (Server-Sent Events Stream)
data: {"message":{"type":"Text","text":"Customer has positive service history..."}}`
                },
                'n8n-validator': {
                    name: 'n8n Recommendation Validator',
                    type: 'n8n Workflow',
                    icon: 'n8n',
                    description: 'Validates AI recommendations for compliance, accuracy, and risk assessment',
                    capabilities: ['recommendation_validation', 'compliance_check', 'risk_assessment'],
                    endpoint: 'https://gabrielpierobon.app.n8n.cloud/webhook/7c319881-0ba1-4cce-8c34-34d59b276569',
                    method: 'POST',
                    requestSchema: `{
  "task": "validate energy efficiency recommendations",
  "data": {
    "customer_data": { ... },
    "sap_enterprise_data": { ... },
    "ai_recommendations": { ... },
    "validation_type": "energy_efficiency_compliance",
    "original_inquiry": { ... }
  },
  "timestamp": "2025-01-18T10:00:15Z",
  "source": "multi_agent_orchestrator"
}`,
                    responseSchema: `[
  {
    "output": {
      "validation_passed": true,
      "approval_status": "approved",
      "compliance_score": 92,
      "risk_level": "low",
      "validation_details": {
        "regulatory_compliance": "passed",
        "accuracy_check": "passed",
        "customer_eligibility": "verified",
        "cost_estimates_verified": true
      },
      "estimated_savings": "$23-37/month",
      "recommendations": [
        "All recommendations meet regulatory standards",
        "Customer qualifies for all suggested programs",
        "Cost estimates are within acceptable ranges"
      ],
      "validation_timestamp": "2025-01-18T10:00:18Z"
    }
  }
]`
                }
            };

            const agent = agents[agentType];
            const headers = agent.headers ? `<div class="api-section">
                    <h3>üìã Required Headers</h3>
                    <div class="code-block">${agent.headers}</div>
                </div>` : '';

            const agentIdInfo = agent.agentId ? `<div class="info-badge type">Agent ID: ${agent.agentId}</div>` : '';

            const iconText = agent.icon === 'n8n' ? 'n8n' : agent.icon === 'sap' ? 'SAP' : agent.icon === 'salesforce' ? 'SF' : 'Azure';
            
            return `
                <div class="agent-details-header">
                    <div class="agent-icon ${agent.icon}">${iconText}</div>
                    <div class="agent-details-title">
                        <h2>${agent.name}</h2>
                        <p>${agent.description}</p>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div class="info-badge type">${agent.type}</div>
                    ${agentIdInfo}
                    ${agent.capabilities.map(cap => `<div class="info-badge capability">${cap}</div>`).join('')}
                </div>

                <div class="api-section">
                    <h3>üåê API Endpoint</h3>
                    <div class="api-endpoint">
                        <span class="method">${agent.method}</span> <span class="url">${agent.endpoint}</span>
                    </div>
                </div>

                ${headers}

                <div class="api-section">
                    <h3>üì§ Request Schema</h3>
                    <div class="code-block">${escapeHtml(agent.requestSchema)}</div>
                    <button class="copy-btn" onclick="copyToClipboard(\`${agent.requestSchema.replace(/`/g, '\\`')}\`, this)">üìã Copy Request</button>
                </div>

                <div class="api-section">
                    <h3>üì• Response Schema</h3>
                    <div class="code-block">${escapeHtml(agent.responseSchema)}</div>
                    <button class="copy-btn" onclick="copyToClipboard(\`${agent.responseSchema.replace(/`/g, '\\`')}\`, this)">üìã Copy Response</button>
                </div>
            `;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copied!';
                button.style.background = '#28a745';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#667eea';
                }, 2000);
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const registerModal = document.getElementById('registerModal');
            const detailsModal = document.getElementById('agentDetailsModal');
            if (event.target == registerModal) {
                hideRegisterModal();
            }
            if (event.target == detailsModal) {
                hideAgentDetails();
            }
        }
    </script>
</body>
</html>
